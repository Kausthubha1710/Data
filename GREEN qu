WITH weekly_latest AS (
    SELECT
        b."AppName",
        DATE_TRUNC('week', b."ImportDate"::date) AS week_start,
        MAX(b."ImportDate"::date) AS latest_date
    FROM pilothouse_admin.wasabi_bg01_reporting b
    GROUP BY 1, 2
),
filtered_data AS (
    SELECT b.*
    FROM pilothouse_admin.wasabi_bg01_reporting b
    JOIN weekly_latest wl 
      ON wl."AppName" = b."AppName" 
      AND DATE_TRUNC('week', b."ImportDate"::date) = wl.week_start
      AND b."ImportDate"::date = wl.latest_date
)
SELECT
    -- This "WeekDate" will become your dynamic column header
    DATE_TRUNC('week', b."ImportDate"::date)::date AS "WeekDate", 
    COALESCE(a."it_sub_cluster", 'Unknown SubCluster') AS "SubClusterName", 
    a."application" AS "ApplicationName",
    COUNT(*) AS "TotalCount"
FROM filtered_data b
LEFT JOIN pilothouse_admin.wasabi_get_apmsubcluster a ON a."application" = b."AppName"
WHERE a."it_sub_cluster" IN ($ApmSubCluster)
  AND b."ImportDate" >= CURRENT_DATE - INTERVAL '4 weeks'
GROUP BY 1, 2, 3
ORDER BY "WeekDate" DESC;
