Goal (what you‚Äôll get at the end)
A Grafana table like this:
SubCluster
Application
2024-12-16
2024-12-23
2024-12-30
2025-01-06
Total
‚úî Column headers are actual ImportDate week starts
‚úî Fully automatic week-to-week
‚úî No Grafana hacks
‚úî Clean dashboard
STEP-BY-STEP PROCESS
üîπ STEP 1: Identify the latest week
Run this once to verify your data:
Copy code
Sql
SELECT MAX(DATE_TRUNC('week', "ImportDate"::date)) AS latest_week
FROM pilothouse_admin.wasabi_bg01_reporting;
üìå Note this value ‚Äî dynamic SQL will compute it automatically later.
üîπ STEP 2: Decide where dynamic SQL will live
‚úÖ Best choice: PostgreSQL FUNCTION
Why?
Grafana can query it like a table
Clean
Reusable
üëâ We‚Äôll create one function and never touch Grafana again.
üîπ STEP 3: Create the function (core step)
Run this in your PostgreSQL database (once).
Copy code
Sql
CREATE OR REPLACE FUNCTION get_weekly_app_counts()
RETURNS SETOF record
LANGUAGE plpgsql
AS $$
DECLARE
    w0 date;
    w1 date;
    w2 date;
    w3 date;
    sql text;
BEGIN
    -- 1. Find latest week
    SELECT MAX(DATE_TRUNC('week', "ImportDate"::date))
    INTO w0
    FROM pilothouse_admin.wasabi_bg01_reporting;

    -- 2. Calculate previous weeks
    w1 := w0 - INTERVAL '1 week';
    w2 := w0 - INTERVAL '2 week';
    w3 := w0 - INTERVAL '3 week';

    -- 3. Build dynamic SQL
    sql := format($f$
        SELECT
            COALESCE(a."it_sub_cluster", 'Unknown') AS "SubCluster",
            a."application" AS "Application",

            COUNT(CASE WHEN DATE_TRUNC('week', b."ImportDate"::date) = %L THEN 1 END) AS "%s",
            COUNT(CASE WHEN DATE_TRUNC('week', b."ImportDate"::date) = %L THEN 1 END) AS "%s",
            COUNT(CASE WHEN DATE_TRUNC('week', b."ImportDate"::date) = %L THEN 1 END) AS "%s",
            COUNT(CASE WHEN DATE_TRUNC('week', b."ImportDate"::date) = %L THEN 1 END) AS "%s",

            COUNT(*) AS "Total"
        FROM pilothouse_admin.wasabi_bg01_reporting b
        LEFT JOIN pilothouse_admin.wasabi_get_apmsubcluster a
            ON a."application" = b."AppName"
        GROUP BY a."it_sub_cluster", a."application"
        ORDER BY "Total" DESC
    $f$,
        w3, w3,
        w2, w2,
        w1, w1,
        w0, w0
    );

    -- 4. Execute and return result
    RETURN QUERY EXECUTE sql;
END;
$$;
üîπ STEP 4: Query the function correctly (important)
Because the function returns record, Grafana (and SQL) must know column types.
Use this query in Grafana:
Copy code
Sql
SELECT *
FROM get_weekly_app_counts() AS t(
    "SubCluster" text,
    "Application" text,
    "Week_3" int,
    "Week_2" int,
    "Week_1" int,
    "Current_Week" int,
    "Total" int
);










CREATE OR REPLACE FUNCTION get_weekly_app_counts()
RETURNS TABLE (
    "SubCluster" text,
    "Application" text,
    w3 int,
    w2 int,
    w1 int,
    w0 int,
    "Total" int
)
LANGUAGE plpgsql
AS $$
DECLARE
    w0_date date;
    w1_date date;
    w2_date date;
    w3_date date;
    sql text;
BEGIN
    -- latest week
    SELECT MAX(DATE_TRUNC('week', "ImportDate"::date))
    INTO w0_date
    FROM pilothouse_admin.wasabi_bg01_reporting;

    w1_date := w0_date - INTERVAL '1 week';
    w2_date := w0_date - INTERVAL '2 week';
    w3_date := w0_date - INTERVAL '3 week';

    sql := format($f$
        SELECT
            COALESCE(a."it_sub_cluster"::text, 'Unknown') AS "SubCluster",
            a."application"::text AS "Application",

            COUNT(CASE WHEN DATE_TRUNC('week', b."ImportDate"::date) = %L THEN 1 END) AS "%s",
            COUNT(CASE WHEN DATE_TRUNC('week', b."ImportDate"::date) = %L THEN 1 END) AS "%s",
            COUNT(CASE WHEN DATE_TRUNC('week', b."ImportDate"::date) = %L THEN 1 END) AS "%s",
            COUNT(CASE WHEN DATE_TRUNC('week', b."ImportDate"::date) = %L THEN 1 END) AS "%s",

            COUNT(*) AS "Total"
        FROM pilothouse_admin.wasabi_bg01_reporting b
        LEFT JOIN pilothouse_admin.wasabi_get_apmsubcluster a
            ON a."application" = b."AppName"
        GROUP BY a."it_sub_cluster", a."application"
        ORDER BY "Total" DESC
    $f$,
        w3_date, w3_date,
        w2_date, w2_date,
        w1_date, w1_date,
        w0_date, w0_date
    );

    RETURN QUERY EXECUTE sql;
END;
$$;






CREATE OR REPLACE FUNCTION get_weekly_app_counts_dyn()
RETURNS TABLE (
    "SubCluster" text,
    "Application" text,
    "Total" bigint
)
LANGUAGE plpgsql
AS $$
DECLARE
    week_rec record;
    col_list text := '';
    sql text;
BEGIN
    -- 1Ô∏è‚É£ Loop over last 4 weeks to build dynamic COUNT columns
    FOR week_rec IN
        SELECT DISTINCT DATE_TRUNC('week', "ImportDate"::date) AS week_start
        FROM pilothouse_admin.wasabi_bg01_reporting
        ORDER BY week_start DESC
        LIMIT 4
    LOOP
        col_list := col_list || format(
            'COUNT(CASE WHEN DATE_TRUNC(''week'', b."ImportDate"::date) = ''%s'' THEN 1 END) AS "%s", ',
            week_rec.week_start,
            to_char(week_rec.week_start, 'YYYY-MM-DD')
        );
    END LOOP;

    -- 2Ô∏è‚É£ Remove trailing comma
    col_list := left(col_list, length(col_list) - 2);

    -- 3Ô∏è‚É£ Build full SQL
    sql := format('
        SELECT
            COALESCE(a."it_sub_cluster", ''Unknown'') AS "SubCluster",
            a."application" AS "Application",
            %s,
            COUNT(*) AS "Total"
        FROM pilothouse_admin.wasabi_bg01_reporting b
        LEFT JOIN pilothouse_admin.wasabi_get_apmsubcluster a
            ON a."application" = b."AppName"
        GROUP BY a."it_sub_cluster", a."application"
        ORDER BY "Total" DESC;
    ', col_list);

    -- 4Ô∏è‚É£ Execute dynamic SQL and return result
    RETURN QUERY EXECUTE sql;
END;
$$;







CREATE OR REPLACE FUNCTION get_weekly_app_counts_dyn()
RETURNS SETOF record
LANGUAGE plpgsql
AS $$
DECLARE
    week_rec record;
    col_list text := '';
    sql text;
BEGIN
    -- Build dynamic columns for last 4 weeks
    FOR week_rec IN
        SELECT DISTINCT DATE_TRUNC('week', "ImportDate"::date) AS week_start
        FROM pilothouse_admin.wasabi_bg01_reporting
        ORDER BY week_start DESC
        LIMIT 4
    LOOP
        col_list := col_list || format(
            'COUNT(CASE WHEN DATE_TRUNC(''week'', b."ImportDate"::date)::date = ''%s''::date THEN 1 END) AS "%s", ',
            week_rec.week_start,
            to_char(week_rec.week_start, 'YYYY-MM-DD')
        );
    END LOOP;

    col_list := left(col_list, length(col_list) - 2); -- remove trailing comma

    sql := format('
        SELECT
            COALESCE(a."it_sub_cluster"::text, ''Unknown''::text) AS "SubCluster",
            a."application"::text AS "Application",
            %s,
            COUNT(*) AS "Total"
        FROM pilothouse_admin.wasabi_bg01_reporting b
        LEFT JOIN pilothouse_admin.wasabi_get_apmsubcluster a
            ON a."application" = b."AppName"
        GROUP BY a."it_sub_cluster", a."application"
        ORDER BY "Total" DESC;
    ', col_list);

    RETURN QUERY EXECUTE sql;
END;
$$;
