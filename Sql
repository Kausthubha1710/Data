SELECT
    date_trunc('day', TO_DATE(wir."ImportDate", 'YYYY-MM-DD')) AS "time",
    as2."name" AS "APM SubCluster",

    COUNT(CASE WHEN wib."Status" = 'Pending' THEN wib.id END) AS "PENDING",
    COUNT(CASE WHEN wib."Status" = 'InProgress' THEN wib.id END) AS "IN_PROGRESS",
    COUNT(CASE WHEN wib."Status" = 'Blocked' THEN wib.id END) AS "BLOCKED",
    COUNT(CASE WHEN wib."Status" = 'Completed' THEN wib.id END) AS "COMPLETED"

FROM pilothouse.wwwwwwwasabi_infora02_reporting wir

FULL JOIN (
    SELECT *
    FROM pilothouse.wwwwwwwasabi_infora02_base
    WHERE TO_DATE("ImportDate", 'YYYY-MM-DD') = (
        SELECT MAX(TO_DATE("ImportDate", 'YYYY-MM-DD'))
        FROM pilothouse.wwwwwwwasabi_infora02_reporting
    )
) wib
    ON wir."PAM_LOGINNAME" = wib."PAM_LOGINNAME"
    AND wir."APPLICATION_BAM_VALUE" = wib."APPLICATION_BAM_VALUE"
    AND wir."pam_timestamp" = wib."pam_timestamp"
    AND wir."APPLICATION" = wib."APPLICATION"
    AND wir."SERVER_ID" = wib."SERVER_ID"
    AND wir."ENVIRONMENT Server" = wib."ENVIRONMENT Server"
    AND wir."AREA" = wib."AREA"
    AND wir."INFRAVERSION" = wib."INFRAVERSION"
    AND wir."PAMELA_COUNTRY" = wib."PAMELA_COUNTRY"
    AND wir."PAM_TECHNOTYPE" = wib."PAM_TECHNOTYPE"
    AND wir."PAM_CLUSTERNAME" = wib."PAM_CLUSTERNAME"
    AND wir."PAM_LOGINLASTCONNECTION" = wib."PAM_LOGINLASTCONNECTION"
    AND wir."metier" = wib."metier"
    AND wir."Account Type" = wib."Account Type"
    AND wir."productionmanager" = wib."productionmanager"
    AND wir."dapsproduction ManagerDelegatesname" = wib."dapsproduction ManagerDelegatesname"
    AND wir."appStatus" = wib."appStatus"
    AND wir."UID User" = wib."UID User"

LEFT JOIN pilothouse.apm_application_daps aad
    ON wir."APPLICATION_BAM_VALUE" = aad.goldenapp_auid
LEFT JOIN pilothouse.apm_applications aa
    ON aa.id = aad.apm_application
LEFT JOIN pilothouse.apm_clusters ac
    ON aa.apm_cluster = ac.id
LEFT JOIN pilothouse.apm_subclusters as2
    ON aa.apm_subcluster = as2.id

WHERE
    wir."PAM LOGINNAME" NOT IN (
        SELECT wim.account_name
        FROM pilothouse.wasabi_infraaccounts_metadata wim
        WHERE wim.infra_type = 'oracle_infra_others'
    )
    AND as2."id" IN ($ApmSubCluster)
    AND TO_DATE(wir."ImportDate", 'YYYY-MM-DD') BETWEEN ($Date) AND ($Date)
    AND wir."ENVIRONMENT Server" IN ($(Environment:sqlstring))

GROUP BY
    date_trunc('day', TO_DATE(wir."ImportDate", 'YYYY-MM-DD')),
    as2."name"

ORDER BY
    date_trunc('day', TO_DATE(wir."ImportDate", 'YYYY-MM-DD')),
    as2."name";
