SELECT 
    date_trunc('day', wir."ImportDate"::date) AS "time",
    as2."name" AS "APM SubCluster",
    COUNT(CASE WHEN COALESCE(wib."Status", wir."Status") = 'Pending' THEN 1 END) AS "PENDING",
    COUNT(CASE WHEN COALESCE(wib."Status", wir."Status") = 'InProgress' THEN 1 END) AS "IN_PROGRESS",
    COUNT(CASE WHEN COALESCE(wib."Status", wir."Status") = 'Blocked' THEN 1 END) AS "BLOCKED",
    COUNT(CASE WHEN COALESCE(wib."Status", wir."Status") = 'Completed' THEN 1 END) AS "COMPLETED"
FROM pilothouse.wwwwwwwasabi_infora02_reporting wir
LEFT JOIN pilothouse.wwwwwwwasabi_infora02_base wib 
    ON wir."PAM_LOGINNAME" = wib."PAM_LOGINNAME"
    AND wir."APPLICATION_BAM_VALUE" = wib."APPLICATION_BAM_VALUE"
    AND wir."pam_timestamp" = wib."pam_timestamp"
    AND wir."APPLICATION" = wib."APPLICATION"
    AND wir."SERVER_ID" = wib."SERVER_ID"
    AND wir."ENVIRONMENT_Server" = wib."ENVIRONMENT_Server"
    AND wir."AREA" = wib."AREA"
    AND wir."INFRAVERSION" = wib."INFRAVERSION"
    AND wir."PAMELA_COUNTRY" = wib."PAMELA_COUNTRY"
    AND wir."PAM_TECHNOTYPE" = wib."PAM_TECHNOTYPE"
    AND wir."PAM_CLUSTERNAME" = wib."PAM_CLUSTERNAME"
    AND wir."PAM_LOGINLASTCONNECTION" = wib."PAM_LOGINLASTCONNECTION"
    AND wir."metier" = wib."metier"
    AND wir."Account_Type" = wib."Account_Type"
    AND wir."productionmanager" = wib."productionmanager"
    AND wir."dapsproduction_ManagerDelegatesname" = wib."dapsproduction_ManagerDelegatesname"
    AND wir."appStatus" = wib."appStatus"
    AND wir."UID_User" = wib."UID_User"
    AND wir."ImportDate"::date = (SELECT MAX("ImportDate"::date) FROM pilothouse.wwwwwwwasabi_infora02_reporting) -- JOIN ONLY FOR LATEST DATE
LEFT JOIN pilothouse.apm_application_daps aad 
    ON wir."APPLICATION_BAM_VALUE" = aad.goldenapp_auid
LEFT JOIN pilothouse.apm_applications aa 
    ON aa.id = aad.apm_application
LEFT JOIN pilothouse.apm_clusters ac 
    ON aa.apm_cluster = ac.id
LEFT JOIN pilothouse.apm_subclusters as2 
    ON aa.apm_subcluster = as2.id
WHERE wir."PAM_LOGINNAME" NOT IN (
    SELECT wim.account_name 
    FROM pilothouse.wasabi_infraaccounts_metadata wim 
    WHERE wim.infra_type = 'oracle_infra_others'
)
AND as2."id" IN ($ApmSubCluster)
AND wir."ImportDate"::date BETWEEN ($Date) AND ($Date)
AND wir."ENVIRONMENT_Server" IN ($(Environment:sqlstring))
GROUP BY date_trunc('day', wir."ImportDate"::date), as2."name"
ORDER BY date_trunc('day', wir."ImportDate"::date), as2."name";
