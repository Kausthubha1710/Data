def extraVars = ""

pipeline {
    agent { label "bnpp-deploytools" }

    environment {
        artifactoryCred = "cibdbdbce-artifactory-credentials"
    }

    stages {

        stage('Initialize') {
            steps {
                script {
                    initializeParameters()
                    def buildNo = currentBuild.displayName
                    currentBuild.displayName += " >> ${params.report}"
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Copy XMLs from OneDrive') {
            steps {
                bat '''
                    echo === Copying XML files from OneDrive ===
                    if not exist "%WORKSPACE%\\xml_files" mkdir "%WORKSPACE%\\xml_files"
                    xcopy "C:\\Users\\h59281\\OneDrive - BNP Paribas\\xml_files\\*" "%WORKSPACE%\\xml_files\\" /E /Y
                    echo === XML copy complete ===
                '''
            }
        }

        stage('Config file copy to workspace') {
            steps {
                script {
                    configFileProvider([configFile(fileId: "credential-wasabi", variable: 'yars_file')]) {
                        sh 'echo ### Config File Copy ###'
                    }
                }
            }
        }

        stage('Create PIP config file') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: artifactoryCred,
                                                     usernameVariable: 'ARTIFACTORY_USERNAME',
                                                     passwordVariable: 'ARTIFACTORY_PASSWORD')]) {
                        bat '''
                            echo [global] > %USERPROFILE%\\.pip\\pip.conf
                            echo index-url=https://%ARTIFACTORY_USERNAME%:%ARTIFACTORY_PASSWORD%@artifactory.cib.echonet/artifactory/api/pypi/pypi/simple >> %USERPROFILE%\\.pip\\pip.conf
                            echo === PIP config created ===
                        '''
                    }
                }
            }
        }

        stage('Execute Python Script') {
            steps {
                bat '''
                    pip install -r requirements.txt
                    python main.py --table "%report%"
                '''
            }
        }
    }
}

def getChoices() {
    return ['sync', 'reporting', 'both', 'base']
}

def initializeParameters() {
    def parameterList = [
        choice(name: 'report',
               choices: getChoices(),
               description: 'Please select the Target Environment')
    ]

    properties([
        buildDiscarder(logRotator(
            artifactDaysToKeepStr: '7',
            artifactNumToKeepStr: '5',
            daysToKeepStr: '7',
            numToKeepStr: '5'
        )),
        durabilityHint('PERFORMANCE_OPTIMIZED'),
        parameters(parameterList)
    ])
}
