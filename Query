WITH date_range AS (
    SELECT generate_series(
        (SELECT MIN("ImportDate")::date FROM pilothouse.wasabi_infora02_reporting),
        (SELECT MAX("ImportDate")::date FROM pilothouse.wasabi_infora02_reporting),
        interval '1 day'
    )::date AS "Date"
),
subclusters AS (
    SELECT DISTINCT COALESCE(as2."name", 'Unknown SubCluster') AS "SubClusterName"
    FROM pilothouse.wasabi_infora02_reporting wir
    LEFT JOIN pilothouse.apm_application_daps aad
        ON wir."APPLICATION_BAM_VALUE" = aad.goldenapp_auid
    LEFT JOIN pilothouse.apm_applications aa
        ON aa.id = aad.apm_application
    LEFT JOIN pilothouse.apm_subclusters as2
        ON aa.apm_subcluster = as2.id
)
SELECT
    d."Date",
    s."SubClusterName",
    COUNT(wir."PAM_LOGINNAME") AS "Count"
FROM date_range d
CROSS JOIN subclusters s
LEFT JOIN pilothouse.wasabi_infora02_reporting wir
    ON wir."ImportDate"::date = d."Date"
LEFT JOIN pilothouse.apm_application_daps aad
    ON wir."APPLICATION_BAM_VALUE" = aad.goldenapp_auid
LEFT JOIN pilothouse.apm_applications aa
    ON aa.id = aad.apm_application
LEFT JOIN pilothouse.apm_subclusters as2
    ON aa.apm_subcluster = as2.id
WHERE COALESCE(as2."name", 'Unknown SubCluster') = s."SubClusterName"
GROUP BY d."Date", s."SubClusterName"
ORDER BY d."Date", s."SubClusterName";





............

SELECT
    date_trunc('$Interval', wir."ImportDate") AS "time",
    COALESCE(as2."name", 'Unknown SubCluster') AS "SubClusterName",
    COUNT(wir."PAM_LOGINNAME") AS "Count"
FROM
    pilothouse.wasabi_infora02_reporting wir
LEFT JOIN pilothouse.apm_application_daps aad
    ON wir."APPLICATION_BAM_VALUE" = aad.goldenapp_auid
LEFT JOIN pilothouse.apm_applications aa
    ON aa.id = aad.apm_application
LEFT JOIN pilothouse.apm_subclusters as2
    ON aa.apm_subcluster = as2.id
WHERE
    wir."ImportDate" BETWEEN '${from:date:YYYY-MM-DD}' AND '${to:date:YYYY-MM-DD}'
    AND wir."PAM_LOGINNAME" NOT IN (
        SELECT wim.account_name
        FROM pilothouse.wasabi_infraaccounts_metadata wim
        WHERE wim.infra_type = 'oracle_infra_others'
    )
GROUP BY
    date_trunc('$Interval', wir."ImportDate"),
    COALESCE(as2."name", 'Unknown SubCluster')
ORDER BY
    date_trunc('$Interval', wir."ImportDate");
